FROM ghcr.io/railwayapp/nixpacks:debian-1663027579

ENTRYPOINT ["/bin/bash", "-l", "-c"]
WORKDIR /app/



# setup phase
COPY .nixpacks/setup.nix .nixpacks/setup.nix
RUN nix-env -if .nixpacks/setup.nix && nix-collect-garbage -d

# load variables
ARG CI DISCORD_TOKEN GITHUB_PAT NIXPACKS_METADATA NODE_ENV NPM_CONFIG_PRODUCTION RAILWAY_DEPLOYMENT_ID RAILWAY_ENVIRONMENT RAILWAY_ENVIRONMENT_ID RAILWAY_GIT_AUTHOR RAILWAY_GIT_BRANCH RAILWAY_GIT_COMMIT_MESSAGE RAILWAY_GIT_COMMIT_SHA RAILWAY_GIT_REPO_NAME RAILWAY_GIT_REPO_OWNER RAILWAY_PROJECT_ID RAILWAY_SERVICE_ID RAILWAY_SERVICE_LP_COMPAT_URL RAILWAY_SNAPSHOT_ID RAILWAY_STATIC_URL
ENV CI=$CI DISCORD_TOKEN=$DISCORD_TOKEN GITHUB_PAT=$GITHUB_PAT NIXPACKS_METADATA=$NIXPACKS_METADATA NODE_ENV=$NODE_ENV NPM_CONFIG_PRODUCTION=$NPM_CONFIG_PRODUCTION RAILWAY_DEPLOYMENT_ID=$RAILWAY_DEPLOYMENT_ID RAILWAY_ENVIRONMENT=$RAILWAY_ENVIRONMENT RAILWAY_ENVIRONMENT_ID=$RAILWAY_ENVIRONMENT_ID RAILWAY_GIT_AUTHOR=$RAILWAY_GIT_AUTHOR RAILWAY_GIT_BRANCH=$RAILWAY_GIT_BRANCH RAILWAY_GIT_COMMIT_MESSAGE=$RAILWAY_GIT_COMMIT_MESSAGE RAILWAY_GIT_COMMIT_SHA=$RAILWAY_GIT_COMMIT_SHA RAILWAY_GIT_REPO_NAME=$RAILWAY_GIT_REPO_NAME RAILWAY_GIT_REPO_OWNER=$RAILWAY_GIT_REPO_OWNER RAILWAY_PROJECT_ID=$RAILWAY_PROJECT_ID RAILWAY_SERVICE_ID=$RAILWAY_SERVICE_ID RAILWAY_SERVICE_LP_COMPAT_URL=$RAILWAY_SERVICE_LP_COMPAT_URL RAILWAY_SNAPSHOT_ID=$RAILWAY_SNAPSHOT_ID RAILWAY_STATIC_URL=$RAILWAY_STATIC_URL

# install phase
ENV PATH /app/node_modules/.bin:$PATH
RUN printf '\nPATH=/app/node_modules/.bin:$PATH' >> /root/.profile
COPY . /app/
RUN --mount=type=cache,id=s/688e8261-896a-4712-883f-dc3732e7777a-/usr/local/share/cache/yarn/v6,target=/usr/local/share/.cache/yarn/v6 yarn install --frozen-lockfile

# build phase
COPY . /app/
RUN --mount=type=cache,id=s/688e8261-896a-4712-883f-dc3732e7777a-node_modules/cache,target=node_modules/.cache yarn scrape



# start
CMD ["yarn discord:bot "]

